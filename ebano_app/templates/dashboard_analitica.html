{% extends "base.html" %}

{% block title %}Dashboard de Anal√≠tica | √âbano{% endblock %}

{% block content %}
<section class="dashboard-analitica page-background bg-dashboard-admin">
    <div class="analitica-wrapper">
        <!-- Header Mejorado -->
        <div class="analitica-header">
            <div class="header-content">
                <div class="header-text">
                    <h1 class="titulo-analitica">
                        <i class="bi bi-graph-up-arrow"></i> Dashboard de Anal√≠tica
                    </h1>
                    <p class="subtitulo-analitica">Visualizaci√≥n en tiempo real de m√©tricas clave del negocio</p>
                </div>
                
                <div class="header-actions">
                    <a href="{{ url_for('dashboard_admin') }}" class="btn-header btn-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Panel
                    </a>
                    <a href="{{ metabase_base_url }}" target="_blank" class="btn-header btn-primary" rel="noopener noreferrer">
                        <i class="bi bi-box-arrow-up-right"></i> Metabase Completo
                    </a>
                </div>
            </div>
            
            <!-- Indicador de carga mejorado -->
            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-content">
                    <div class="spinner-container">
                        <div class="spinner"></div>
                    </div>
                    <p class="loading-text">Cargando dashboard de anal√≠tica...</p>
                    <small class="loading-hint">Esto puede tomar 10-30 segundos en la primera carga</small>
                    <div class="loading-progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor del iframe mejorado -->
        <div class="iframe-wrapper" id="iframe-wrapper">
            <div class="iframe-container" id="iframe-container">
                <iframe
                    id="metabase-iframe"
                    src="{{ metabase_url }}"
                    frameborder="0"
                    width="100%"
                    height="100%"
                    allowtransparency
                    sandbox="allow-scripts allow-same-origin allow-forms"
                    title="Dashboard de Anal√≠tica √âbano"
                    loading="eager"
                ></iframe>
            </div>
        </div>
        
        <!-- Mensaje de error mejorado -->
        <div id="error-message" class="error-message" style="display: none;">
            <div class="error-content">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <h3>‚ö†Ô∏è Error al cargar el dashboard</h3>
                <p>El dashboard de Metabase no pudo cargarse correctamente.</p>
                
                <details class="error-details">
                    <summary>Posibles causas y soluciones</summary>
                    <ul>
                        <li><strong>Primera carga:</strong> Metabase puede tardar 30-60 segundos en iniciar por primera vez</li>
                        <li><strong>Free tier de Render:</strong> El servicio puede estar "dormido" y necesita despertar</li>
                        <li><strong>Conexi√≥n lenta:</strong> Intenta recargar la p√°gina en unos segundos</li>
                        <li><strong>Navegador:</strong> Prueba en modo inc√≥gnito o limpia la cach√©</li>
                    </ul>
                </details>
                
                <div class="error-actions">
                    <button onclick="location.reload()" class="btn-error btn-retry">
                        <i class="bi bi-arrow-clockwise"></i> Reintentar
                    </button>
                    <a href="{{ metabase_base_url }}" target="_blank" class="btn-error btn-external" rel="noopener noreferrer">
                        <i class="bi bi-box-arrow-up-right"></i> Abrir Metabase directamente
                    </a>
                    <a href="{{ url_for('dashboard_admin') }}" class="btn-error btn-back">
                        <i class="bi bi-arrow-left"></i> Volver al panel
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Script mejorado para manejar la carga del iframe
(function() {
    const iframe = document.getElementById('metabase-iframe');
    const loadingIndicator = document.getElementById('loading-indicator');
    const iframeContainer = document.getElementById('iframe-container');
    const errorMessage = document.getElementById('error-message');
    const progressBar = document.getElementById('progressBar');
    
    let loadTimeout;
    const MAX_LOAD_TIME = 60000; // 60 segundos timeout
    let checkInterval;
    let progressInterval;
    
    // Funci√≥n para actualizar barra de progreso
    function updateProgress() {
        let progress = 0;
        progressInterval = setInterval(function() {
            progress += 1.67; // 60 segundos / 100% = 1.67% por segundo
            if (progress >= 100) {
                progress = 100;
                clearInterval(progressInterval);
            }
            progressBar.style.width = progress + '%';
        }, 1000);
    }
    
    // Funci√≥n para mostrar error
    function showError() {
        console.error('‚ùå Timeout: El iframe de Metabase no carg√≥ en 60 segundos');
        clearTimeout(loadTimeout);
        clearInterval(checkInterval);
        clearInterval(progressInterval);
        
        loadingIndicator.style.display = 'none';
        iframeContainer.style.display = 'none';
        errorMessage.style.display = 'block';
    }
    
    // Funci√≥n para confirmar carga exitosa
    function onLoadSuccess() {
        console.log('‚úÖ Dashboard de Metabase cargado correctamente');
        clearTimeout(loadTimeout);
        clearInterval(checkInterval);
        clearInterval(progressInterval);
        
        loadingIndicator.style.display = 'none';
        iframeContainer.classList.add('loaded');
    }
    
    // Iniciar barra de progreso
    updateProgress();
    
    // Timeout de seguridad
    loadTimeout = setTimeout(showError, MAX_LOAD_TIME);
    
    // Event listener para carga del iframe
    iframe.addEventListener('load', function() {
        // Esperamos 2 segundos adicionales para que Metabase renderice
        setTimeout(onLoadSuccess, 2000);
    });
    
    // Event listener para error expl√≠cito
    iframe.addEventListener('error', function(e) {
        console.error('‚ùå Error al cargar iframe:', e);
        showError();
    });
    
    // Verificaci√≥n peri√≥dica (cada 5 segundos durante 60 segundos)
    let checkCount = 0;
    checkInterval = setInterval(function() {
        checkCount++;
        console.log(`‚è≥ Esperando carga del dashboard... (${checkCount * 5}s / 60s)`);
        
        if (checkCount >= 12) { // 12 * 5 = 60 segundos
            clearInterval(checkInterval);
        }
        
        // Intentar detectar si el iframe est√° realmente cargado
        try {
            if (iframe.contentWindow && iframe.contentWindow.document) {
                const iframeDoc = iframe.contentWindow.document;
                if (iframeDoc.readyState === 'complete' || 
                    iframeDoc.readyState === 'interactive') {
                    clearInterval(checkInterval);
                    onLoadSuccess();
                }
            }
        } catch (e) {
            // Cross-origin error esperado, el iframe est√° cargando
            console.log('‚ÑπÔ∏è  Iframe cargando (cross-origin)...');
        }
    }, 5000);
    
    console.log('üöÄ Iniciando carga del dashboard de Metabase...');
    console.log('üìç URL del iframe:', iframe.src);
})();
</script>
{% endblock %}